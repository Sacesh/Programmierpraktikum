#!/usr/bin/perl -w
use strict;
use LWP::Simple;
use Getopt::Std;
#Subs

#Trim the whitespace from a string
sub trim {
	my $string = shift;
	$string =~ s/^\s+//;
	$string =~ s/\s+$//;
	return $string;
}

#Get the organism ID, insert it if not existent
sub getOrganismId {
	my $db = $_[0];
	my $organismName = $_[1];
	#Try to fetch an existing organism
	$db->do("SELECT Id from Organism WHERE Name = $organism;")
	$result = $sth->fetchrow_hashref();
	if(defined $result->{Id}) {
		
	}
}

#Insert the information about a sequence file into the database
#Automatically downloads the sequence by AC number
# Arguments: processEntry(db, ID, AC, Definition, Array of Keywords)
sub processSwissprotEntry {
	#Get the function arguments
	my $db = $_[0];
	my $id = $_[1];
	my @ACNumbers = @{$_[2]};
	my $definition = $_[3];
	my $organism = $_[4];
	print $organism,"\n";
	my @keywords = @{$_[5]};
	#print "ACs:",join(",", @ACNumbers),"\n";
	use LWP::Simple;
	#Insert the database entry information
	my $primaryAC = $ACNumbers[0] ;
	$db->do("INSERT INTO DatabaseEntry('Database', 'DatabaseId') VALUES ((SELECT FROM Database WHERE Name = 'SwissProt'), '$primaryAC');"
	#Insert the sequence
	my $url = 'http://www.uniprot.org/uniprot/' .$currentAC  . '.fasta';
	my $fastaSequence = get $url;
	die "Protein sequence for AC $currentAC can't be downloaded!\n" unless defined $fastaSequence;
	
	foreach(@ACNumbers) {
		#Download the sequence in FASTA format by AC number
		my $currentAC = $ACNumbers[0] ;
	}
}
#Parse CLI arguments
my %options=();
getopts("t",\%options);
#Komandozeilenparameter
my $argc = @ARGV;
#Check if we have at least one argument
die "Usage: $0 <SwissProt filename>\n" unless $argc == 1;
#
#Setup the database connection
#
use DBI;
my $db = undef;
my $testMode = defined $options{t};
if($testMode) {
} else {
	$db = DBI->connect('DBI:mysql:bioprakt4;host=mysql2-ext.bio.ifi.lmu.de', 'bioprakt4', 'vGI5GCMg0x') || die "Could not connect to database: $DBI::errstr";	
}
print "Established database connection...";
#Open the file and iterate over the lines
my $swissprotFile = $ARGV[0];
open my $fileHandle, '<', $swissprotFile or die "Could not open file $swissprotFile for reading: $!\n"; 
#Variables in the current entity
my $currentId = "";
my $currentDefinition = "";
my $currentOrganism = "";
my @currentACNumbers= ();
my @currentKeywords =  ();
while ( my $line = <$fileHandle> ) {
        chomp $line;
	#Parse the different lines
        if($line =~ m/^ID\s+(.+).$/) {
		#Process the old dataset
		#print "Last KW: ",join(",",@currentKeywords), "\n";
		#print $currentDefinition,"\n";
		if($currentId) { #If it's not before the first entry
			processSwissprotEntry($db, $currentId, \@currentACNumbers, $currentDefinition, $currentOrganism, \@currentKeywords);
		}
		#Reset the variables. Some of the assignments are not really neccessary but they ease format debugging
		$currentId = "[No ID found]";
		$currentDefinition = "";
		$currentOrganism = "";
		@currentACNumbers = ();
		@currentKeywords = ();
		#Process the new ID line, a new entry starts here
		$currentId = $1;
		chomp $currentId;
	} elsif($line =~ m/^AC\s+([\s;\w]+);$/) {#AC Numbers
		my $currentACEntries = $1;
		my @rawAcNumbers = split(";",$currentACEntries);
		foreach (@rawAcNumbers) {
			push(@currentACNumbers, trim($_));
		}
		#print $1."\n";
        } elsif($line =~ m/^DE\s+(.+);$/) { #Defintions
                $currentDefinition = $currentDefinition . $1; #qnd
        } elsif($line =~ m/^KW\s+(.+).$/) { #Keywords
		my $currentKeywordLine = $1;
		my @keywords = split(/;/,$currentKeywordLine);
		#trim the KWsdefined $options{t}
		my @processedKeywords  = ();
		foreach(@keywords) {
			my $processedKeyword = trim($_);
			push(@processedKeywords, $processedKeyword);
		}
		@currentKeywords = (@currentKeywords, @processedKeywords);
		chomp $currentId;
        } elsif($line =~ m/^OS\s+(.+).$/) { #Organism
                $currentOrganism = $currentOrganism . $1; #qnd
        }
}
#Do some cleanup
$db->disconnect() unless defined $testMode;
close $fileHandle;